name: Run ruff linting and formatting check
on:
    workflow_call:
        inputs:
            skip_ruff:
                type: boolean
                required: false
                default: false
                description: "Skip ruff execution"

            source_paths:
                type: string
                required: false
                default: "."
                description: "Space-separated source paths to lint (e.g., 'src' or 'backend code')"

            python_version:
                type: string
                required: false
                default: "3.12"

            install_script:
                type: string
                required: false
                default: ""
                description: "Optional script to run before linting"

            use_lfs:
                type: boolean
                required: false
                default: false

            has_ssh_key:
                type: boolean
                required: false
                default: false

        secrets:
            REPOSITORY_USER_TOKEN:
                required: true

jobs:
    run_ruff:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  lfs: ${{ inputs.use_lfs }}

            - name: Checkout LFS objects if needed
              if: ${{ inputs.use_lfs }}
              run: git lfs checkout

            - name: Checkout workflows repo for shared config
              uses: actions/checkout@v4
              with:
                  repository: vinsa-ai/workflows
                  token: ${{ secrets.REPOSITORY_USER_TOKEN }}
                  path: .workflows-config

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ inputs.python_version }}

            - name: Setup SSH
              if: ${{ inputs.has_ssh_key }}
              uses: MrSquaare/ssh-setup-action@v3.1.0
              with:
                  host: github.com
                  private-key: ${{ secrets.ACTIONS_SSH_KEY }}

            - name: Install dependencies
              run: |
                  pip install --upgrade pip
                  pip install ruff
                  if [ -f requirements.txt ]; then
                    pip install -r requirements.txt
                  fi

            - name: Execute install script
              if: ${{ inputs.install_script != '' }}
              run: ${{ inputs.install_script }}

            - name: Run ruff
              if: ${{ !inputs.skip_ruff }}
              run: |
                  # Use shared config from workflows repository
                  CONFIG_FILE=$(realpath .workflows-config/ruff.toml)
                  echo "Using shared ruff config: $CONFIG_FILE"

                  REPO_PATH=$(pwd)

                  # Run ruff on each path
                  for path in ${{ inputs.source_paths }}; do
                    echo "======================================================"
                    echo "Running ruff check on: $path"
                    echo "Using config: $CONFIG_FILE"
                    echo "======================================================"

                    cd $path
                    ruff check --config "$CONFIG_FILE" .

                    echo ""
                    echo "Running ruff format check on: $path"
                    ruff format --check --config "$CONFIG_FILE" .

                    cd $REPO_PATH

                    echo "âœ“ Ruff passed for $path"
                  done

            - name: Warning about ruff
              if: ${{ inputs.skip_ruff }}
              run: |
                  echo '::warning::Ruff is disabled for this run.'
