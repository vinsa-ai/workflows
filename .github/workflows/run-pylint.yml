name: Run pylint and verify code quality
on:
    workflow_call:
        inputs:
            skip_pylint:
                type: boolean
                required: false
                default: false
                description: "Skip pylint execution"

            source_paths:
                type: string
                required: false
                default: "."
                description: "Space-separated source paths to lint (e.g., 'src' or 'backend code')"

            python_version:
                type: string
                required: false
                default: "3.12"

            install_script:
                type: string
                required: false
                default: ""
                description: "Optional script to run before linting"

            use_lfs:
                type: boolean
                required: false
                default: false

            has_ssh_key:
                type: boolean
                required: false
                default: false

        secrets:
            REPOSITORY_USER_TOKEN:
                required: true

jobs:
    run_pylint:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  lfs: ${{ inputs.use_lfs }}

            - name: Checkout LFS objects if needed
              if: ${{ inputs.use_lfs }}
              run: git lfs checkout

            - name: Checkout workflows repo for shared config
              uses: actions/checkout@v4
              with:
                  repository: vinsa-ai/workflows
                  token: ${{ secrets.REPOSITORY_USER_TOKEN }}
                  path: .workflows-config

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ inputs.python_version }}

            - name: Setup SSH
              if: ${{ inputs.has_ssh_key }}
              uses: MrSquaare/ssh-setup-action@v3.1.0
              with:
                  host: github.com
                  private-key: ${{ secrets.ACTIONS_SSH_KEY }}

            - name: Install dependencies
              run: |
                  pip install --upgrade pip
                  pip install pylint
                  if [ -f requirements.txt ]; then
                    pip install -r requirements.txt
                  fi

            - name: Execute install script
              if: ${{ inputs.install_script != '' }}
              run: ${{ inputs.install_script }}

            - name: Run pylint
              if: ${{ !inputs.skip_pylint }}
              run: |
                  # Determine which .pylintrc to use
                  if [ -f ".pylintrc" ]; then
                    RCFILE=$(realpath .pylintrc)
                    echo "Using repository's .pylintrc"
                  else
                    RCFILE=$(realpath .workflows-config/.pylintrc)
                    echo "Using shared .pylintrc from workflows repository"
                  fi

                  REPO_PATH=$(pwd)

                  # Run pylint on each path
                  for path in ${{ inputs.source_paths }}; do
                    echo "======================================================"
                    echo "Running pylint on: $path"
                    echo "Using config: $RCFILE"
                    echo "======================================================"

                    cd $path

                    TEMP_OUTPUT=$(mktemp)
                    set +e
                    pylint --rcfile="$RCFILE" . | tee "$TEMP_OUTPUT"
                    PYLINT_EXIT=${PIPESTATUS[0]}
                    set -e

                    cd $REPO_PATH

                    # Check for E or F errors (Error and Fatal levels)
                    if grep -qE "^[^:]+:[0-9]+:[0-9]+: [EF][0-9]+" "$TEMP_OUTPUT"; then
                      rm -f "$TEMP_OUTPUT"
                      echo "::error::Pylint found errors in $path"
                      exit $PYLINT_EXIT
                    fi

                    rm -f "$TEMP_OUTPUT"
                    echo "âœ“ Pylint passed for $path (no E or F level issues)"
                  done

            - name: Warning about pylint
              if: ${{ inputs.skip_pylint }}
              run: |
                  echo '::warning::Pylint is disabled for this run.'
